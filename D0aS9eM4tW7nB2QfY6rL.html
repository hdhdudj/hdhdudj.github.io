<!doctype html>
<meta charset="utf-8">
<title>마니또 짝 뽑기</title>
<style>
  body{font-family:sans-serif;max-width:600px;margin:40px auto}
  #out{margin-top:16px;background:#f6f6f6;padding:12px;border-radius:8px;white-space:pre-wrap}
</style>

<h1>마니또 짝 뽑기</h1>

<label>내 이름: <input id="myName" placeholder="스프레드시트의 이름과 정확히 동일하게 입력"></label>
<br><br>
<button id="btn">짝 뽑기</button>

<pre id="out"></pre>

<script>
/** Apps Script 웹앱의 exec URL 로 교체하세요 */
const WEBAPP_BASE = 'https://script.google.com/macros/s/AKfycby-qSeiXWVD1GesvPkF8aBNsktzQ-MNzadA9Ztz4JMr8iVW-L0iWWYaoJOd1i8_-Bfx/exec';

/** JSONP 콜백 (전역) */
function onClaim(resp){
  console.log('[onClaim]', resp);
  const out = document.getElementById('out');
  if(!resp){ out.textContent = '응답 없음'; return; }
  if(!resp.ok){
    out.textContent = '오류: ' + (resp.error || 'unknown');
    return;
  }
  out.textContent = resp.already
    ? `이미 배정됨: ${resp.assigned}`
    : `당신의 마니또는: ${resp.assigned}`;
}

/** JSONP 로더 (에러 감지 포함) */
function loadJsonp(url){
  return new Promise((resolve, reject)=>{
    const s = document.createElement('script');
    s.src = url + '&_=' + Date.now(); // 캐시 버스터
    s.onload = () => resolve();        // 로드 성공 (콜백은 별도로 실행됨)
    s.onerror = () => reject(new Error('JSONP 스크립트 로드 실패(권한/배포/네트워크 확인)'));
    document.body.appendChild(s);
  });
}

document.getElementById('btn').onclick = async () => {
  const nameRaw = document.getElementById('myName').value;
  const myName = (nameRaw || '').trim();
  if(!myName){ alert('이름을 입력하세요'); return; }

  // UID를 사용자에게 보이지 않게 "이름과 동일"로 사용
  const uid = myName;

  const url = `${WEBAPP_BASE}?action=claim`
            + `&myName=${encodeURIComponent(myName)}`
            + `&uid=${encodeURIComponent(uid)}`
            + `&callback=onClaim`;

  const out = document.getElementById('out');
  out.textContent = '요청 중...';

  try{
    await loadJsonp(url);
  }catch(e){
    console.error(e);
    out.textContent = '요청 실패: ' + e.message
      + '\n- 웹앱 배포가 /exec 인지\n- Execute as: Me, Who has access: Anyone with the link 인지\n- 조직 정책(익명 허용) 확인';
  }
};
</script>
